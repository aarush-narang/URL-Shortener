<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="stylesheet" href="index.css">
    <meta charset="UTF-8">
    <title>Home</title>
</head>

<body>
    <div>
        <form id='link-form'>
            <label for="link">Enter Link:</label><br>
            <input type="text" id="link" name="link"><br>
            <input id="link-submit" type="submit" value="Submit">
        </form>
    </div>
    <script>
        const domain = 'http://127.0.0.1:5000/'
        function copy_short_link() {
            const copyText = document.querySelector("#link");
            copyText.select();
            document.execCommand("copy");
        }

        window.addEventListener("load", function () {
            function sendData() {
                const XHR = new XMLHttpRequest();
                XHR.addEventListener("load", function (event) {
                    input.value = `${domain}${event.target.responseText}`
                    check_input_value(event.target.responseText)
                    link_submit_button.value = 'Copy'
                    link_submit_button.type = 'button'
                    
                    document.querySelector("#link-submit").addEventListener("click", copy_short_link);
                });
                XHR.addEventListener("error", function (event) {
                    alert('Oops! Something went wrong.');
                });
                XHR.open("POST", "/url_shorten");
                XHR.send(JSON.stringify({ "link": input.value }));
            }
            function check_input_value(short_link) {
                const input_check = setInterval(() => {
                    if (input.value != `${domain}${short_link}`) {
                        link_submit_button.value = 'Submit'
                        link_submit_button.type = 'submit'
                        clearInterval(input_check)
                    }
                }, 100);
            }
            const form = document.getElementById("link-form")
            const input = document.getElementById("link")
            const link_submit_button = document.getElementById('link-submit')
            form.addEventListener("submit", function (event) {
                event.preventDefault();
                const link_regex = new RegExp(/[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()@:%_\+.~#?&//=]*)?/gi)
                const current_domain_regex = new RegExp(/((http:\/\/)?127\.0\.0\.1:5000\/).+/gi)
                if (!input.value.match(link_regex)) {
                    alert('Please enter a valid link!') // later change this so that it says it in the html not as an alert
                } else if (input.value.match(current_domain_regex)) {
                    alert('Please enter a link that does not include this website\'s domain!')
                } else {
                    sendData();
                }
            });
        });
    </script>
</body>

</html>